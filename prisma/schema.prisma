// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
    ADMIN
    BUYER
    SELLER
}

enum SellerRole {
    MANAGER
    ACCOUNTANT
    INVENTORY_STAFF
}

enum UserStatus {
    ACTIVE
    SUSPENDED
    BANNED
}

enum OrderStatus {
    PENDING_APPROVAL
    PROCESSING
    OUT_FOR_DELIVERY
    COMPLETED
    CANCELLED
    REJECTED
}

enum PaymentMethod {
    CASH_ON_DELIVERY
    BKASH
}

enum PaymentStatus {
    PENDING
    COMPLETED
    FAILED
    REFUNDED
}

// Models
model User {
    id       String     @id @default(cuid())
    email    String     @unique
    password String
    name     String
    phone    String?
    avatar   String?
    role     UserRole   @default(BUYER)
    status   UserStatus @default(ACTIVE)

    // Seller specific fields
    sellerRole      SellerRole?
    businessName    String?
    businessPhone   String?
    businessAddress String?

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    refreshTokens RefreshToken[]
    products      Product[]
    orders        Order[]        @relation("BuyerOrders")
    sellerOrders  Order[]        @relation("SellerOrders")
    reviews       Review[]
    cartItems     CartItem[]
    notifications Notification[]

    @@map("users")
}

model RefreshToken {
    id        String   @id @default(cuid())
    token     String   @unique
    userId    String
    expiresAt DateTime
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("refresh_tokens")
}

model Category {
    id          String   @id @default(cuid())
    name        String   @unique
    description String?
    image       String?
    slug        String   @unique
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    products Product[]

    @@map("categories")
}

model Product {
    id              String    @id @default(cuid())
    title           String
    description     String
    price           Decimal   @db.Decimal(10, 2)
    discountPrice   Decimal?  @db.Decimal(10, 2)
    discountEndDate DateTime?
    stock           Int       @default(0)
    sku             String    @unique
    isActive        Boolean   @default(true)

    // Media
    images String[] // Array of Cloudinary URLs
    video  String? // Cloudinary video URL

    // Relations
    categoryId String
    sellerId   String

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    category   Category    @relation(fields: [categoryId], references: [id])
    seller     User        @relation(fields: [sellerId], references: [id])
    orderItems OrderItem[]
    reviews    Review[]
    cartItems  CartItem[]

    @@map("products")
}

model Order {
    id            String        @id @default(cuid())
    orderNumber   String        @unique
    status        OrderStatus   @default(PENDING_APPROVAL)
    paymentMethod PaymentMethod
    paymentStatus PaymentStatus @default(PENDING)

    // Totals
    subtotal     Decimal @db.Decimal(10, 2)
    shippingCost Decimal @default(0) @db.Decimal(10, 2)
    tax          Decimal @default(0) @db.Decimal(10, 2)
    total        Decimal @db.Decimal(10, 2)

    // Addresses
    shippingAddress Json
    billingAddress  Json?

    // Payment Details
    paymentDetails Json?
    bkashTrxId     String?

    // Relations
    buyerId  String
    sellerId String

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    buyer         User                 @relation("BuyerOrders", fields: [buyerId], references: [id])
    seller        User                 @relation("SellerOrders", fields: [sellerId], references: [id])
    items         OrderItem[]
    statusHistory OrderStatusHistory[]

    @@map("orders")
}

model OrderItem {
    id       String  @id @default(cuid())
    quantity Int
    price    Decimal @db.Decimal(10, 2) // Price at the time of order

    orderId   String
    productId String

    order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id])

    @@map("order_items")
}

model OrderStatusHistory {
    id        String      @id @default(cuid())
    status    OrderStatus
    notes     String?
    createdAt DateTime    @default(now())

    orderId String
    order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

    @@map("order_status_history")
}

model Review {
    id      String   @id @default(cuid())
    rating  Int // 1-5 stars
    comment String?
    images  String[] // Array of image URLs

    productId String
    userId    String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Ensure one review per user per product
    @@unique([productId, userId])
    @@map("reviews")
}

model CartItem {
    id       String @id @default(cuid())
    quantity Int    @default(1)

    userId    String
    productId String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    // Ensure one cart item per user per product
    @@unique([userId, productId])
    @@map("cart_items")
}

model Notification {
    id      String  @id @default(cuid())
    title   String
    message String
    type    String // 'order_status', 'payment', 'general', etc.
    isRead  Boolean @default(false)
    data    Json? // Additional data for the notification

    userId String

    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("notifications")
}

// Analytics and Reporting Models
model DailyStats {
    id            String   @id @default(cuid())
    date          DateTime @unique
    totalOrders   Int      @default(0)
    totalRevenue  Decimal  @default(0) @db.Decimal(12, 2)
    totalUsers    Int      @default(0)
    totalProducts Int      @default(0)

    createdAt DateTime @default(now())

    @@map("daily_stats")
}
